\documentclass[11pt]{amsart}
\usepackage{geometry}                % See geometry.pdf to learn the layout options. There are lots.
\geometry{letterpaper}                   % ... or a4paper or a5paper or ... 
\input{../p.tex}
\title{Approximating the Optimal State Abstraction}
\author{}
\date{}                                           % Activate to display a given date or no date

% --- Note Commands ---
\newcommand\davenote[1]{\textcolor{blue}{Dave: #1}}

\begin{document}
\maketitle
\section{Results}

Recall, there is a ground MDP $M$ we want to solve. We homogenize to an MDP $M'$, and apply $\phi$ to $M'$ to get an abstract MDP $A$.

For each approximate $\phi$ type, we want to show, $\forall_{\epsilon} : \epsilon \in [0 : \infty)$
\begin{equation}
\forall_{s,a} : | V^{\pi^*_M}(s) - V^{\pi^*_{M'}}(s) | \leq \epsilon
\end{equation}

We consider four $\phi$ types:
% phi model
\begin{align*}
\encircle{\text{ $\phi_m$ }}\ & : \phi_{m}(s_1) = \phi_m(s_2) \rightarrow \forall_a |\mathcal{R}(s_1,a) - \mathcal{R}(s_2,a)| \leq \epsilon \ \wedge\ 
\forall_{a,s' \in \phi^{-1}(\bar{s})} | \mathcal{T}(s_1,a,s') - \mathcal{T}(s_2,a,s') | \leq \epsilon \\
\encircle{\text{ $\phi_{Q^*}$ }}\ & : \phi_{Q^*}(s_1) = \phi_{Q^*}(s_2) \rightarrow \forall_a |Q^*(s_1,a) - Q^*(s_2,a)| \leq \epsilon \\
\encircle{\text{ $\phi_{D}$ }}\ & : \phi_D(s_1) = \phi_D(s_2) \rightarrow \Delta \left( \Pr_{a \in \mathcal{A}}(a \mid s_1) \mid\mid \Pr_{a \in \mathcal{A}}(a \mid s_2) \right) \leq \epsilon \\
\encircle{\text{ $\phi_{a^*}$ }}\ & : \phi_{a^*}(s_1) = \phi_{a^*}(s_2) \rightarrow \argmax_a Q^*(s_1,a) = \argmax_a Q^*(s_2, a) \wedge |\max_a Q^*(s_1,a) - \max_a Q^*(s_2,a)| \leq \epsilon  \\
\end{align*}

\elem{NOTE:} Instead of performing the abstraction w.r.t. $\phi$, our new strategy is to, given an MDP $M$ (and possibly some other information, $\kappa$), apply a function $H$ to create $M'$, for which all of the old $\phi$ functions may operate.

Specifically:
\begin{multline}
H(f, \epsilon) \rightarrow f' \text{  s.t.  } \\ \forall_{(s_1,a,s_1'),(s_2,a,s_2')} \left(f'(s_1,a,s_1') = f'(s_2,a,s_2') \rightarrow | f(s_1,a,s_1') - f(s_2,a,s_2') | \leq \epsilon\right)
\end{multline}

Where:
\begin{equation}
f(s,a,s') \rightarrow \mathbb{R}
\end{equation}

% Other results to consider: phi compression can be arbitrarily bad for other methods of approximate compression. Sample complexity increase can be arbitrarily large.

\elem{NOTE:} We are {\it not} going to provide results for $\phi_{\pi^*}$, since relaxing equality of optimal actions doesn't mean anything.

\elem{NOTE:} Additionally, we are {\it not} going to provide results for $\phi_{Q^\pi}$, since as Lihong's paper notes, ``It is an open question how to find $Q^\pi$ irrelevance abstractions without enumerating all possible policies, they do not give results. Furthermore, an MDP for which this is true is an awfully weird MDP...

\elem{NOTE:} For $\phi_D$, we consider the space of distributions on optimal Q values where:
\begin{equation}
f(Q(s,a)) > f(Q(s,a_2)) \rightarrow Q(s,a_1) > Q(s,a_2)
\end{equation}

\newpage
% Subsection: phi_m Results
\section{$\phi_{m}$ Results}

Let the maximum upper bound between optimal behavior in the noisy and ground MDP be called $B_s$.

\begin{align*}
B_{s} &= \max_{s,a}|Q'(s,a)-Q(s,a)|\\
B_{s} &= |R_s' - R_s + \gamma \sum_{s'}\left[T'Q'-TQ\right]|\\
&=|R'_s-R_s + \gamma \sum_{s'}\left[(T+T'-T)Q'-TQ\right]|\\
&\leq |R'_s-R_s|+|\gamma \sum_{s'}\left[(T+\epsilon_{\text{transition}})Q' - TQ\right]|\\
&\leq \epsilon_{\text{reward}}+|\gamma \sum_{s'}\left[(TQ'+\epsilon_{\text{transition}}Q' - TQ\right]|\\
&\leq \epsilon_{\text{reward}}+|\gamma \sum_{s'}\left[(T(Q'-Q)+\epsilon_{\text{transition}}Q' \right]|\\
&\leq \epsilon_{\text{reward}}+|\gamma |\mathcal{S}|\epsilon_{transition}Q'_{\text{max}} + \gamma \sum_{s'}\left[ T B_s\right]|\\
&\leq \epsilon_{\text{reward}} + \gamma B_{s} + \gamma |\mathcal{S}|\epsilon_{\text{transition}}Q'_{max}|\\
B_{s} &\leq 
\frac
{{\epsilon_{\text{reward}}} + \gamma |\mathcal{S}|\epsilon_{transition}V'_{\text{max}}}
{1-\gamma}
\end{align*}

Therefore, since there is a bound on $B_s$, we can conclude that:
\begin{equation}
\forall_{s,a} : |Q'(s,a) - Q(s,a) \leq \frac{{\epsilon_{\text{reward}}} + \gamma |\mathcal{S}|\epsilon_{transition}V'_{\text{max}}}{1-\gamma}
\end{equation}

Consequently, from the below $\phi_Q^*$ results, we conclude that:
\begin{equation}
\forall_s : |V^{\pi^*_M}(s) - V^{\pi^*_{M'}}(s)| \leq \frac{{\epsilon_{\text{reward}}} + \gamma |\mathcal{S}|\epsilon_{transition}V'_{\text{max}}}{1-\gamma}
\end{equation}
\qed


\newpage
% Subsection: phi_Q^* Results
\section{$\phi_{Q^*}$ Results}

We consider a non-temporally homogenized MDP parameterized by T, such that for the first T time steps the MDP is defined as the abstract MDP, and after T time steps, the MDP becomes identical to the ground MDP.

We proceed by induction on T.

\elem{Base:}

When T = 0, we show that:
\begin{equation}
|V^{\pi_G^S}(s) - V_0(s)| \leq \epsilon
\end{equation}

Trivial, since $V_0 = V^{\pi_G^S}(s)$.

\elem{Inductive:}

IH: Suppose $|V^{\pi_G^*}(s) - V_T(s)| \leq \sum_{t=o}^T \epsilon \gamma^t$.

WTS: $|V^{\pi_G^*}(s) - V_{T+1}(s)| \leq \sum_{t=o}^{T+1} \epsilon \gamma^t$.

\begin{align*}
V_{T+1}(s) &= \max_a \left[R_{T+1}(s,a) + \gamma \sum_s' T_{T+1}(s,a,s')V_T(s')\right] \\
&\leq \max_a \left[R_{T+1}(s,a) + \gamma \sum_s' T_{T+1}(s,a,s')\left(V_0(s) + \sum_{t=0}^T\epsilon\gamma^t \right) \right] \\
&= \gamma\left(\sum_{t=0}^T\epsilon\gamma^T\right) + \max_a \left[R_{T+1}(s,a) + \gamma \sum_s' T_{T+1}(s,a,s')V_0(s') \right] \\
&= \gamma\left(\sum_{t=0}^T\epsilon\gamma^T\right) + \max_a \left[\sum_{g \in s} R_{G}(g,a)\omega(g) + \gamma \sum_s' \sum_{g \in s}T_G(g,a,s')\omega(g)V_0(s') \right] \\
&= \gamma\left(\sum_{t=0}^T\epsilon\gamma^T\right) + \epsilon + \left(\max_a Q_G(s,a)\right) \\
&= \sum_{t=0}^{T+1} \epsilon \gamma^{T+1} + \max_a Q^{\pi_G^*}(s,a) \\
&= \frac{\epsilon}{1-\gamma} + V^{\pi_G^*}(s) \\
\end{align*}
\begin{equation}
\therefore |V^{\pi_G^*}(s) - V_{T+1}(s)| \leq | V^{\pi_G^*}(s) - \frac{\epsilon}{1-\gamma} + V^{\pi_G^*}(s)| = \frac{\epsilon}{1-\gamma} \qed
\end{equation}

%We know:
%\begin{equation}
%\forall_{s_1,s_2,a} : \phi_{Q^*}(s_1) = \phi_{Q^*}(s_2) \rightarrow | Q^{\pi^*_M}(s_1,a) - Q^{\pi^*_{M}}(s_2,a)| \leq \epsilon
%\label{eq:phi_q_assumption}
%\end{equation}
%
%Since `max' is a non-expansion, we know:
%\begin{equation}
%\forall_s : |\max_a Q^{\pi^*_M}(s,a) - \max_{a'} Q^{\pi^*_{M'}}(s,a')| \leq \max_b | Q^{\pi^*_M}(s,b) - Q^{\pi^*_{M'}}(s,b)|
%\end{equation}
%
%From Equation~\ref{eq:phi_q_assumption}, we know:
%\begin{equation}
%\forall_s : |\max_a Q^{\pi^*_M}(s,a) - \max_{a'} Q^{\pi^*_{M'}}(s,a')| \leq \max_b | Q^{\pi^*_M}(s,b) - Q^{\pi^*_{M'}}(s,b)| \leq \epsilon
%\end{equation}
%
%But since $\forall_\pi : V^{\pi} = \max_a Q^\pi(s,a)$, we conclude:
%\begin{equation}
%\forall_s : |V^{\pi^*_M}(s) - V^{\pi^*_{M'}}(s)| \leq \epsilon
%\end{equation}
%\qed

\newpage
% Subsection: phi_D Results
\section{$\phi_{D}$ Results}

\begin{equation}
\forall_{s_1, s_2 \in \mathcal{S}_M} : \phi_D(s_1) = \phi_D(s_2) \rightarrow \forall_{i \in [0:|\mathcal{A}| - 1]} | g_i(Q_M^*(s_1, \cdot) - g_i(Q_M^*(s_2, \cdot) | \leq \epsilon
\label{eq:phi_d}
\end{equation}

Where:
\begin{equation}
g(Q_M^*(s,\cdot)) : \mathbb{R}^{|\mathcal{A}|} \longmapsto \mathbb{R}^{|\mathcal{A}|}
\end{equation}

And there is a bound on the derivative of $g$:
\begin{equation}
\forall_{i \in [0:\mathcal{A}-1]} : K \cdot |g_i(\vec{x}) - g_i(\vec{y})| \geq |x_i - y_i |
\label{eq:bounded_derivative}
\end{equation}

From Equation~\ref{eq:phi_d} we know:
\begin{equation}
|g_i(Q_M^*(s_1,\cdot)) - g_i(Q_M^*(s_2,\cdot))| \leq \epsilon
\end{equation}

From Equation~\ref{eq:bounded_derivative} we know:
\begin{equation}
|Q_i(s_1,\cdot) - Q_i(s_2,\cdot)| \leq K |g_i(Q_M^*(s_1,\cdot)) - g_i(Q_M^*(s_2,\cdot))|
\end{equation}

Therefore:
\begin{equation}
|Q_i(s_1,\cdot) - Q_i(s_2,\cdot)| \leq K \epsilon
\end{equation}

From our previous $Q^*$ results, we conclude \qed




%Instead of letting $\phi_D$ denote a probability distribution\footnote{There are issue with this. Effectively, once the states are collapsed, there are arbitrarily many actual Q functions that could have given rise to the same action distributions, so we can't really say much in M' about Q.} we instead consider a more general class of abstraction functions:
%\begin{equation}
%\tau : \forall_{s_1,s_2 \in \mathcal{S}_M} : \tau(s_1) = \tau(s_2) \rightarrow \forall_a : | \Omega(s_1,a) - \Omega(s_2,a) | \leq \epsilon
%\end{equation}
%
%That is, we consider abstraction where some function $\Omega : \mathcal{S} \times \mathcal{A} \rightarrow \mathbb{R}$ is bounded for two states
%
%We want to prove:
%\begin{equation}
%\forall_{s \in \mathcal{S}_M} | V^{\pi_M^*}(s) - V^{\pi_A^*}(s) | \leq f(\epsilon)
%\end{equation}
%
%Since:
%\begin{equation}
%V^{\pi_A^*}(s) = Q^{\pi_A^*}(s, \pi_A^*(\tau(s)))
%\end{equation}
%
%We can rewrite in terms of $Q$ functions:
%\begin{equation}
%\forall_{s \in \mathcal{S}_M} : | Q^{\pi_M^*}(s, \pi_M^*(s)) - Q^{\pi_A^*}(s, \pi_A^*(\tau(s))) | \leq f(\epsilon)
%\label{eq:phi_d_q_func}
%\end{equation}
%
%Now, for any states we collapsed, we know:
%\begin{equation}
%\forall_{a \in \mathcal{A}} : | \Omega(s_1,a) - \Omega(s_2,a) | \leq \epsilon
%\label{eq:omega_consequent}
%\end{equation}
%
%In this setup, we can place constraints on $\Omega$ that will let us get from Equation~\ref{eq:omega_consequent} to Equation~\ref{eq:phi_d_q_func}
%
%Based on our earlier discussions, there seem to be three things that make sense:
%\begin{align*}
%\Omega(s,a) &= g(\mathcal{T}(s,a)) \\
%\Omega(s,a) &= g(\mathcal{R}(s,a)) \\
%\Omega^\pi(s,a) &= g(Q^\pi(s,a))
%\end{align*}
%For some function $g$.
%
%Suppose we go with the third. What properties need to be true of $g$ for this to go through?
%\begin{enumerate}[A.]
%\item $g$ is linear
%\item $g$ is monotonically increasing
%\item For a given domain of acceptable $Q^\pi$ values, $g$ has an infimum and supremum
%\end{enumerate}
%
%Then, from Equation~\ref{eq:omega_consequent}, we know:
%\begin{equation}
%|g(Q^{\pi_M^*}(s,\pi_M^*(s))) - g(Q^{\pi_A^*}(s, \pi_A^*(\tau(s)))) | \leq \epsilon
%\end{equation}
%
%Since $g$ is linear:
%\begin{equation}
%|g\left(Q^{\pi_M^*}\left(s,\pi_M^*(s)\right) - Q^{\pi_A^*}\left(s, \pi_A^*(\tau(s))\right)\right) | \leq \epsilon
%\end{equation}
%\begin{equation}
%\therefore g\left(Q^{\pi_M^*}\left(s,\pi_M^*(s)\right) - Q^{\pi_A^*}\left(s, \pi_A^*(\tau(s))\right)\right) \leq \epsilon
%\end{equation}
%
%What we want to say here is that by properties (2) and (3), since it's monotonically increasing, and there is a supremum and infimum, we can conclude that:
%\begin{equation}
%Q^{\pi_M^*}\left(s,\pi_M^*(s)\right) - Q^{\pi_A^*}\left(s,\pi_M^*(s)\right) \leq g^{-1}(\epsilon)
%\end{equation}
%
%Where $g^{-1}(\epsilon)$ is (1) well defined, (2) at most a polynomial function of epsilon. If the above properties don't get us there, what would?

\section{BOOP}

\thm{Theorem}{1}{There are three pairs of functions, $\langle \phi_1, f_1 \rangle$, $\langle \phi_2, f_2 \rangle$, and $\langle \phi_3, f_3 \rangle$ such that:
\begin{equation*}
\forall_{s_1, s_2 \in S_M} : \phi_{i}(s_1) = \phi_{i}(s_2) \rightarrow \forall_a :  |f_i(s_1,a) - f_i(s_2,a)| \leq \epsilon
\end{equation*}

Where, the MDP resulting from the abstracted state space, $A$, when solved, provides the policy $\pi^*_A$, such that:
\begin{equation*}
\forall_{s \in S_M} : | V^{\pi^*_M}(s) - V^{\pi^*_{A}}(s) | \leq poly(\epsilon)
\end{equation*}}

\newpage
% Subsection: phi_a^* Results
\section{$\phi_{a^*}$ Results}




% --- BIBLIOGRAPHY ---
\newpage
\bibliography{sca_bib}

\end{document}
